<!DOCTYPE html>
<html lang="en">

<head>
    {% load static %}
    <meta charset="UTF-8">
    <title>Approve Purchase Requisition Form - Smart Office | Foxconn</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/12.1.2/css/intlTelInput.css'>
    <link rel='stylesheet' href='https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css'>
    <link rel='stylesheet'
          href='https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/css/nice-select.min.css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.2/emojionearea.css"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="{% static 'office_app/css/chat.css' %}">
    <!-- font icon -->
    <link href="{% static 'purchase/css/elegant-icons-style.css' %}" rel="stylesheet"/>
    <!-- Custom styles -->
    <link href="{% static 'purchase/css/style2.css' %}" rel="stylesheet">
    <link href="{% static 'purchase/css/style-responsive.css' %}" rel="stylesheet"/>


</head>

<body class="pr_form">

<!-- Multi step form -->
<section class="multi_step_form">
    <form id="msform" name="msform" method="POST">
        {% csrf_token %}
        <!-- Tittle -->
        <div class="tittle">
            <h1>Approve Purchase Requisition Form</h1>
        </div>
        <!--menu bar-->
        <nav class="navbar navbar-expand-lg navbar-light  bg-light rounded nav nav-tabs">
            <a class="ml-5 h7">Welcome, {{ request.session.full_name }}.</a>

            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown"
                    aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse justify-content-end" id="navbarNavDropdown">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a href="{% url 'purchase_dashboard' %}" class="nav-link">Home</a>
                    </li>
                    <li class="nav-item dropdown">
                        <div class="dropdown">
                            <a class="btn dropdown-toggle" type="button" id="PurchasedropdownMenuButton"
                               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Purchase Form Menu
                            </a>

                            <div class="dropdown-menu" aria-labelledby="PurchasedropdownMenuButton">
                                <a class="dropdown-item" href="./new">Create Purchase Request </a>
                                <a class="dropdown-item" href="{% url 'purchase_to_approve' %}">Approve Purchase Request</a>
                            </div>
                        </div>
                    </li>

                    <li class="nav-item mr-sm-2">
                        <a href="{% url 'logout' %}" class="nav-link text-danger">Log Out</a>
                    </li>
                </ul>
            </div>
        </nav>

        <fieldset>
            <div class="m-3">
                <div class="row">
                    <div class="col-lg-12">
                        <section class="card">
                            <header class="card-header bg-foxconn">
                                Forms to Approve (PR Form)
                            </header>
                            <div class="card-header m-3" id="filterType">
                                <label class="pr-3">Show:</label>
                            </div>
                            <div class="card-body bg-white">
                                <div class="col-md-12" data-animation="scaleIn">
                                    <table class="table table-bordered table-striped table-hover responsive"
                                           id="dataTable" width="100%" cellspacing="0">
                                        <thead>
                                        <tr>
                                            <th> PR Item Total </th>
                                            <th>PR Number</th>
                                            <th>Application Date</th>
                                            <th>Purpose</th>
                                            <th>Item Desc.</th>
                                            <th>PO Number</th>
                                            <th>Action</th>
                                        </tr>
                                        </thead>
                                    </table>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </fieldset>


    </form>
</section>

<!-- JS Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/12.1.2/js/intlTelInput.js'></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/js/jquery.nice-select.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.4.0/bootbox.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/promise-polyfill"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.3.0/jquery.form.min.js"
        integrity="sha384-qlmct0AOBiA2VPZkMY3+2WqkHtIQ9lSdAsAn5RUJD/3vA5MKDgSGcdmIv4ycVxyn"
        crossorigin="anonymous"></script>
<!--Moments Js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.26.0/moment-with-locales.min.js"></script>
<!--Emoji Js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.2/emojionearea.js"></script>
<!-- custom javascripts -->
<script src="{% static 'purchase/js/corrinas_purchase_javascript.js' %}"></script>
<script src="{% static 'purchase/js/script.js' %}"></script>
<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.ui.position.js"></script>
<script>
    $(document).ready(function () {

        let dataTable = $('#dataTable').DataTable({
            ajax: {
                url: "{% url 'purchase_to_approve_api' %}",
                dataSrc: 'submitted',
                error: function (err) {
                    swal.fire({
                        text: "Error getting data. Please contact IT Administrator",
                        icon: "error"
                    });
                }
            },
            responsive: {
                details: {
                    display: $.fn.dataTable.Responsive.display.childRowImmediate,
                    type: 'none',
                    target: ''
                }
            },

            order: [ 1, "desc" ],
            columns: [
                {"data" : 'form_total'},
                {"data": 'pr_Number'},
                {"data": 'creationDate'},
                {"data": 'purpose'},
                {
                    "data": "items_detail",
                    "render": function (data, type, row) {
                        let str = []

                        $.each(row.items_detail, function (index, value) {
                            $.each(value.approval_process, function (j, name){
                                str += '<br/>' + 'Item:  ' + value.description + '<hr/>'+'<br/>';
                            })

                        })

                        return "<i class='fas fa-eye text-secondary mr-2' title='Click to View Item Description' onclick='view_description(\"" + str + "\")' style='cursor: pointer' data-toggle='tooltip'> Item Description</i>"
                    }
                },

                {
                    "data": "items_detail",
                    "render": function (data, type, row) {
                        let str = "";

                        $.each(row.items_detail, function (index, value) {
                            if (value.po_num != null)
                                str += value.po_num + "<br>";
                        });

                        return str
                    }
                },

                {"data": 'action_required'}

            ],

            initComplete: function () {

                this.api().columns(6).every( function () {
                    var column = this;

                    var buttons = $('<button class="btn btn-secondary">All</button>' +
                        '<button class="btn btn-light">Action Required</button>' +
                        '<button class="btn btn-light">Approved</button>' +
                        '<button class="btn btn-light">Declined</button>');

                    buttons.appendTo($('#filterType')).on( 'mouseover', function () {

                        buttons.removeClass('btn-secondary').addClass('btn-light');
                        $(this).removeClass('btn-light').addClass('btn-secondary');

                        let val = this.innerText;

                        if  (val === 'All')
                            column.search('', true, false ).draw();
                        else if (val ===  'Approved')
                            column
                                    .search('^(Approved|Updated and sent to approvers).*$', true, false )
                                    .draw();
                        else
                            column.search( val ? '^'+val+'$' : '', true, false ).draw();
                    });

                } );
            }

        });

        $('#dataTable tbody').on('mouseover', 'td:not(:nth-last-child(3))', function () {
            $(this).css('cursor', 'pointer')
        });


        $('#dataTable tbody').on('click', 'td:not(:nth-last-child(3))', function openpage () {
            let data = dataTable.row(this).data();
            window.location.href= "../purchase_request/" + data["formID"];
        });


        $.contextMenu({
            selector: 'td',
            trigger: 'right',

            items: {
                "open": {
                    name: " Open PR-Form in a New Tab",
                    icon: "fas fa-book-open",
                    callback: function () {
                        let data = dataTable.row(this).data();
                        window.open("../purchase_request/" + data["formID"], "_blank");
                    }

                },
            }
        })

    });


    function view_description(str) {
        swal.fire({
            title: 'Item Description(s)',
            html:  str,
            icon: 'info',
            showCancelButton: false,
            showLoaderOnConfirm: true,
            confirmButtonText: 'Go Back to Form',
            reverseButtons: true,
        })

    }

</script>
{#{#}
{#                    "render": function (data, type, row) {#}
{#                        if (row.employee !== 'administrator')#}
{#                            return "<i class='fas fa-edit text-secondary mr-2' title='Edit' onclick='edit_costcenter(\"" + row.costCenterCode + "\")' style='cursor: pointer'></i>" +#}
{#                                "<i class='fas fa-minus-circle fa-1x text-danger mr-2' title='Delete' onclick='delete_costcenter(\"" + row.costCenterCode + "\")' style='cursor: pointer'></i>";#}
{#                        else#}
{#                            return ""#}
{##}
{#                    }#}
{#                }#}
{##}
{#columns: [#}
{#                { "data": 'pr_Number' },#}
{#                { "data": 'creationDate' },#}
{#                { "data": 'project' },#}
{##}
{#                { "data": "items",#}
{#                    "render": "[, ].Description"#}
{#                },#}
{#                 { "data": "items",#}
{#                    "render":"[, ].stage"#}
{#                },#}
{##}
{#                  { "data": "items",#}
{#                    "render": "[, ].approved"#}
{#                },#}
{##}
{#            ]#}
{#        });#}






{##}
{##}
{#                {#}
{#                    "data": "item",#}
{#                    "render": function (data, type, row) {#}
{#                        let str = []#}
{#                        $.each(row.items, function (index, value) {#}
{#                            str += value.description + "<br>";#}
{#                        })#}
{#                        return str#}
{#                    }#}
{#                },#}
{#                {#}
{#                    "data": "item",#}
{#                    "render": function (data, type, row) {#}
{#                        let str = []#}
{#                        $.each(row.items, function (index, value) {#}
{#                            str += value.stage + "<br>";#}
{#                        })#}
{#                        return str#}
{#                    }#}
{#                },#}
{##}
{#                {#}
{#                    "data": "item",#}
{#                    "render": function (data, type, row) {#}
{#                        let str = []#}
{#                        $.each(row.items, function (i, v) {#}
{#                            if (v.approved === true)#}
{#                                str += "Approved, ";#}
{##}
{#                            else if (v.declined === true)#}
{#                                str += "Declined ";#}
{##}
{#                        })#}
{#                        return str#}
{#                    }#}
{#                },#}
{##}
{#                {#}
{#                    "data": "item",#}
{#                    "render": function (data, type, row) {#}
{#                        return 1122;#}
{#                    }#}
{#                },#}
{##}
{#                {#}
{#                    "data": "item",#}
{#                    "render": function (data, type, row) {#}
{#                    if (v.action_required === true)#}
{#                        str = "<b>ACTION REQUIRED</b>, ";#}
{##}
{#                    else if (v.declined === true)#}
{#                        str = "";#}
{#                        return str#}
{#                    }#}
{#                },#}
